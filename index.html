<!doctype html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>

    <script src="helpers/common_helpers.js"></script>
    <script src="helpers/pixi_helpers.js"></script>
    <script src="helpers/keyboard_listeners.js"></script>
    <script src="helpers/controller_listeners.js"></script>

    <script src="components/concerns/player_view_concern.js"></script>
    <script src="components/player_view.js"></script>
    <script src="components/event_model.js"></script>

    <link rel="icon" type="image/x-icon" href="assets/ico/favicon.ico">
  </head>
  <body>
    <p><b>Navigation </b>Move right: press d; Move left: press a</p>
  </body>
  <script>
    const app = new PIXI.Application({ background: '#1099bb', width: 900, height: 360 });
    document.body.appendChild(app.view);

    const loadBackground = (w, h) => {
      const sprite = PIXI.Sprite.from('assets/bg.jpg');
      sprite.width = w;
      sprite.height = h;
      const container = new PIXI.Container();
      container.addChild(sprite);
      return container;
    }

    PIXI.Assets.load([
      'assets/minotaur.json',
      'assets/bg.jpg'
    ]).then(() => {
      window.player = initPlayerView(app.screen.width / 2, 340, app.screen.width);
      app.stage.addChild(loadBackground(app.screen.width, app.screen.height));
      app.stage.addChild(player.container);

      window.eventModel = new EventModel({LEFT: PlayerView.DIRECTIONS.LEFT, RIGHT: PlayerView.DIRECTIONS.RIGHT});

      const controller = drawController(app.stage, 90, app.screen.height - 90);
      subscribeConrollerEvents(controller, eventModel);
      subscribeKeyboardEvents(eventModel);
      eventModel.subscribe('any', (e, m) => {
        if (m.hasEvents) {
          player.state = player.constructor.STATES.WALK;
          player.direction = m.lastEvent;
        } else {
          player.state = player.constructor.STATES.IDLE;
        }
      });

      app.ticker.add(delta => {
        player.tick(delta);
      });
    });
  </script>
</html>
